import { Link } from 'react-router-dom';
import React, { useEffect } from 'react';
import grid from 'flexboxgrid/dist/flexboxgrid.css';

import { tokenMap, routes } from '@constants';
import { DateTimeFromTimestamp } from '@toolbox/timestamp';
import Box from '@toolbox/box';
import BoxHeader from '@toolbox/box/header';
import BoxContent from '@toolbox/box/content';
import CopyToClipboard from '@toolbox/copyToClipboard';
import Feedback from '@toolbox/feedback/feedback';
import LabeledValue from '@toolbox/labeledValue';
import LiskAmount from '@shared/liskAmount';
import TransactionsTable from '@shared/transactionsTable';
import styles from './blockDetails.css';

const getFields = (data, token, t) => ({
  id: {
    label: t('Block ID'),
    classList: `${grid['col-xs-12']} ${grid['col-sm-10']} ${grid['col-md-8']} ${grid['col-lg-6']}`,
    value: <CopyToClipboard value={data.id} />,
  },
  height: {
    label: t('Height'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: <CopyToClipboard value={data.height} />,
  },
  version: {
    label: t('Version'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: data.version,
  },
  confirmations: {
    label: t('Confirmations'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: data.confirmations ?? '-',
  },
  reward: {
    label: t('Reward'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-1']}`,
    value: <LiskAmount val={data.reward} token={token} />,
  },
  totalFee: {
    label: t('Total fee'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-1']}`,
    value: <LiskAmount val={data.totalFee} token={token} />,
  },
  totalBurnt: {
    label: t('Total burnt'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: <LiskAmount val={data.totalBurnt} token={token} />,
  },
  totalForged: {
    label: t('Total forged'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: <LiskAmount val={data.totalForged} token={token} />,
  },
  totalAmount: {
    label: t('Total amount'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: <LiskAmount val={Math.max(data.totalAmount - data.totalFee, 0)} token={token} />,
  },
  date: {
    label: t('Date'),
    classList: `${grid['col-xs-3']} ${grid['col-sm-2']} ${grid['col-md-2']}`,
    value: (
      <DateTimeFromTimestamp
        time={data.timestamp * 1000}
        token={tokenMap.BTC.key}
      />
    ),
  },
  generator: {
    label: t('Generated by'),
    classList: `${grid['col-xs-3']} ${grid['col-md-2']}`,
    value: (
      <Link to={`${routes.account.path}?address=${data.generatorAddress}`}>
        {data.generatorUsername}
      </Link>
    ),
  },
});

const Rows = ({ data, t }) => {
  const token = tokenMap.LSK.key;
  const fields = getFields(data, token, t);

  const columns = Object.keys(fields).map(field => (
    <LabeledValue
      key={field}
      label={fields[field].label}
      className={`${fields[field].classList} ${styles.dataRow}`}
    >
      {fields[field].value}
    </LabeledValue>
  ));

  return (
    <div className={`${grid.row} ${styles.dataContainer}`}>
      { columns }
    </div>
  );
};

const BlockDetails = ({
  t, blockDetails, blockTransactions, match,
}) => {
  const canLoadMore = blockTransactions.meta
    ? blockTransactions.data.length < blockTransactions.meta.total
    : false;

  useEffect(() => {
    blockDetails.loadData();
    blockTransactions.loadData();
  }, [match.url]);

  return (
    <div>
      <Box isLoading={blockDetails.isLoading} width="full">
        <BoxHeader>
          <h1>{t('Block details')}</h1>
        </BoxHeader>
        <BoxContent>
          { blockDetails.error ? (
            <Feedback
              message={t('Failed to load block details.')}
              status="error"
            />
          ) : (
            <Rows
              data={blockDetails.data}
              t={t}
            />
          )}
        </BoxContent>
      </Box>
      <TransactionsTable
        title={t('Transactions')}
        transactions={blockTransactions}
        emptyState={{ message: t('There are no transactions for this block.') }}
        canLoadMore={canLoadMore}
      />
    </div>
  );
};

export default BlockDetails;
